# Шаги для использования docker-compose.yml

## Скачать дамп OSM данных

Перейдите на сайт [Geofabrik](https://download.geofabrik.de/russia.html) и выберите нужный вам регион, чтобы загрузить актуальный дамп данных в формате `.osm.pbf`. Поместите его в папку `osm` проекта.

## Структура папок

Убедитесь, что у вас есть следующая структура:

```bash
/path/to/project
├── docker-compose.yml
└── osm
    └── russia-latest.osm.pbf
```

Замените `/path/to/project` на путь к вашей рабочей директории.

## Запуск Docker Compose

Перейдите в директорию, где находится ваш `docker-compose.yml` файл, и выполните команду:

```bash
docker-compose up
```

Это запустит процесс извлечения, контрактирования и запуска OSRM сервера.

## Тестирование

После завершения подготовки данных и запуска сервера, вы можете протестировать его с помощью HTTP-запроса:

```bash
curl "http://localhost:5000/route/v1/driving/37.6173,55.7558;30.3158,59.9398?overview=false"
```

Это запросит маршрут от Москвы до Санкт-Петербурга.

## Для пересборки данных из файла `.osm.pbf`, удаляем флаг `/data/ready`

```bash
docker-compose exec osrm-prepare rm /osm/ready
```

## Использование мощной машины для подготовки данных и менее мощной для маршрутизации

Вы можете использовать более мощную машину для подготовки данных (extraction и contraction), а затем перенести файлы на менее мощную машину для выполнения маршрутизации (routed). Это распространенный подход, который позволяет эффективно использовать ресурсы. Вот как это можно сделать:

### Подготовка данных на мощной машине

1. **Запуск контейнера `osrm-prepare`:**

   Запустите контейнер `osrm-prepare` на мощной машине с достаточными ресурсами для извлечения и сжатия данных. Убедитесь, что все необходимые файлы (`central-fed-district-latest.osrm`, `central-fed-district-latest.osrm.hsgr`, `central-fed-district-latest.osrm.cells`, и другие связанные файлы) созданы и находятся в одном месте.

### Перенос файлов

2. **Копирование файлов:**

   После завершения подготовки данных скопируйте все созданные файлы OSRM в директорию на вашей менее мощной машине. Вы можете использовать инструменты, такие как `scp` или `rsync`, для переноса файлов, или менеджер FileZilla.

### Запуск маршрутизации на менее мощной машине

3. **Создание файла `ready` и запуск контейнера `osrm-routed`:**

   После того как вы перенесли все необходимые файлы OSRM на менее мощную машину, создайте пустой файл `ready` в директории `/data`, которая монтируется в контейнер для хранения данных. Это можно сделать с помощью команды:

```bash
touch /path/to/mounted/osm/ready
```

   Затем на менее мощной машине запустите контейнер `osrm-routed`, используя скопированные файлы. Убедитесь, что все пути к файлам правильно настроены в вашем `docker-compose.yml` или в командной строке Docker.

## Проверка и тестирование

4. **Проверка работы сервера:**

   Проверьте, что сервер правильно запущен и отвечает на запросы. Убедитесь, что все необходимые порты открыты и доступны.

Этот метод позволяет использовать ресурсы более эффективно, минимизируя нагрузку на менее мощную машину, которая будет использоваться только для маршрутизации.
